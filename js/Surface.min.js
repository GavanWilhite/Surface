var AEROTWIST=AEROTWIST||{};AEROTWIST.Surface=new function(){var t,x,C=null,l=null,P=null,j=$("#container"),a=j.width()-15,e=j.height()-15,y=$("#gui"),I=[],F=new THREE.Projector(),d=new THREE.Vector3(),p=true,O=0,L=0,h=null,D=null,H=[],c=[],r=0.9,u=400,q=500,N=1,J=10000,v=20,M=20,z=400,n=400,K=200,E=true;this.init=function(){document.onselectstart=function(){return false};I.magnitude=30;I.orbitSpeed=0.001;I.orbit=true;I.wireframeOpacity=1;I.raindrops=true;I.elasticity=0.001;w();if(m()){g();f();B();y.addClass("live")}else{$("html").removeClass("webgl").addClass("no-webgl")}};function b(R){R.stopPropagation();R.preventDefault();var Q=R.dataTransfer.files;if(Q.length){i(Q[0])}return false}function i(R){var Q=new FileReader();Q.onloadend=G;Q.readAsDataURL(R)}function G(Q){if(Q.target.result.match(/^data:image/)){h=document.createElement("img");h.src=Q.target.result;setTimeout(function(){o()},100)}else{alert("Umm, images only? ... Yeah")}}function k(Q){if(Q.preventDefault){Q.preventDefault()}return false}function f(){pointLight=new THREE.PointLight(16777215);pointLight.position.x=10;pointLight.position.y=100;pointLight.position.z=10;x.addLight(pointLight)}function g(){var S=new THREE.MeshLambertMaterial({color:16777215,map:ImageUtils.loadTexture("images/72lions_sterik.jpg"),shading:THREE.SmoothShading}),Q=new THREE.MeshLambertMaterial({color:16777215,wireframe:true});D=new THREE.Mesh(new Plane(z,n,v,M),[S,Q]);D.rotation.x=-Math.PI*0.5;D.overdraw=true;x.addChild(D);H=D.geometry.vertices;sCount=H.length;while(sCount--){var R=H[sCount];R.springs=[];R.velocity=new THREE.Vector3();if(R.position.x>(-z*0.5)){R.springs.push({start:sCount,end:sCount-1})}if(R.position.x<(z*0.5)){R.springs.push({start:sCount,end:sCount+1})}if(R.position.y<(n*0.5)){R.springs.push({start:sCount,end:sCount-(v+1)})}if(R.position.y>(-n*0.5)){R.springs.push({start:sCount,end:sCount+(v+1)})}}}function m(){var Q=false;try{C=new THREE.WebGLRenderer();t=new THREE.Camera(45,a/e,N,J);x=new THREE.Scene();l=document.createElement("canvas");l.width=z;l.height=n;P=l.getContext("2d");P.fillStyle="#000000";P.beginPath();P.fillRect(0,0,z,n);P.closePath();P.fill();t.position.y=220;t.position.z=q;C.setSize(a,e);j.append(C.domElement);Q=true}catch(R){Q=false}return Q}function w(){$(window).resize(callbacks.windowResize);$(window).keydown(callbacks.keyDown);$(document.body).mousedown(callbacks.mouseDown);$(document.body).mouseup(callbacks.mouseUp);$(document.body).click(callbacks.mouseClick);var Q=j[0];Q.addEventListener("dragover",k,false);Q.addEventListener("dragenter",k,false);Q.addEventListener("dragexit",k,false);Q.addEventListener("drop",b,false);$(".gui-set a").click(callbacks.guiClick);$(".gui-set a.default").trigger("click")}function o(){var S=1/Math.max(h.width/z,h.height/n);var R=h.width*S;var T=h.height*S;P.drawImage(h,0,0,h.width,h.height,(z-R)*0.5,(n-T)*0.5,R,T);var Q=new THREE.MeshLambertMaterial({color:16777215,map:ImageUtils.loadTexture(l.toDataURL("image/png")),shading:THREE.SmoothShading});D.materials[0]=Q}function B(){O+=I.orbit?I.orbitSpeed:0;t.position.x=Math.sin(O)*q;t.position.z=Math.cos(O)*q;t.update();if(I.raindrops){if(new Date().getTime()-L>K){var W=new THREE.MeshBasicMaterial({color:16777215,opacity:0.7});var R=new THREE.Mesh(new Sphere(2,2,8,8),W);R.velocity=new THREE.Vector3(0,0,0);R.position=new THREE.Vector3(z*0.5-Math.random()*z,600,n*0.5-Math.random()*n);c.push(R);x.addChild(R);L=new Date().getTime()}}var Q=c.length;while(Q--){var R=c[Q];R.velocity.addSelf(new THREE.Vector3(0,-0.3,0));R.position.addSelf(R.velocity);if(R.position.y<0){x.removeChild(R);c.splice(Q,1);var aa=Math.floor((R.position.x/z)*v),V=Math.floor((R.position.z/n)*M);aa+=v*0.5;V+=M*0.5;index=(V*(v+1))+aa;H[index].velocity.z+=I.magnitude*5}}D.materials[1].opacity=I.wireframeOpacity;var Z=H.length;while(Z--){var T=H[Z],S=new THREE.Vector3(0,0,-T.position.z*I.elasticity),U=T.springs,ab=U.length;T.velocity.addSelf(S);while(ab--){var Y=U[ab],X=H[Y.start].position.z-H[Y.end].position.z;S=new THREE.Vector3(0,0,X*I.elasticity*50);H[Y.end].velocity.addSelf(S);H[Y.start].velocity.subSelf(S)}T.position.addSelf(T.velocity);T.velocity.multiplyScalar(r)}D.geometry.computeFaceNormals(true);D.geometry.__dirtyVertices=true;D.geometry.__dirtyNormals=true;requestAnimationFrame(A)}function A(){if(C){C.render(x,t)}B()}function s(Q,U){var T=Q.offsetX||(Q.clientX-220);var S=Q.offsetY||Q.clientY;var R=new THREE.Vector3((T/a)*2-1,-(S/e)*2+1,0.5);F.unprojectVector(R,t);var X=new THREE.Ray(t.position,R.subSelf(t.position).normalize()),V=X.intersectObject(D);if(V.length){var Y=V[0].point,Z=Math.floor((Y.x/z)*v),W=Math.floor((Y.z/n)*M);Z+=v*0.5;W+=M*0.5;index=(W*(v+1))+Z;if(index>=0&&index<H.length){H[index].velocity.z+=U}}}callbacks={mouseDown:function(){document.addEventListener("mousemove",callbacks.mouseMove,false)},mouseMove:function(Q){s(Q,I.magnitude)},mouseClick:function(Q){s(Q,I.magnitude*5)},mouseUp:function(){document.removeEventListener("mousemove",callbacks.mouseMove,false)},guiClick:function(){var R=$(this),S=R.data("guivar"),Q=R.data("guival");if(I[S]!==null){I[S]=Q}R.siblings().addClass("disabled");R.removeClass("disabled");return false},windowResize:function(){if(t){a=j.width()-15,e=j.height()-15,t.aspect=a/e,C.setSize(a,e);t.updateProjectionMatrix()}},keyDown:function(Q){if(t){switch(Q.keyCode){case 37:O-=0.1;break;case 39:O+=0.1;break}t.update()}}}};$(document).ready(function(){if(Modernizr.webgl){AEROTWIST.Surface.init()}});